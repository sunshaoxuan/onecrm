# STD-09-后端代码合规执行标准

**生效日期**: 2026-02-09  
**状态**: 执行中  
**约束来源**: `C:\workspace\PublicDocs\Process\STD-01 ~ STD-08`

---

## 1. 目标与范围

- 本标准用于约束 `backend/` 下所有后端代码、脚本与接口实现。
- 本标准为强制规范，优先级高于个人编码习惯。
- 任何新增后端代码默认受本标准约束。

## 2. 强制规则（MUST）

### 2.1 质量与测试（继承 STD-01, STD-03, STD-06）
- 每次提交前必须执行：`npm run verify`。
- 核心业务逻辑必须有自动化测试，且包含异常路径。
- 任何未通过测试、未通过合规检查的代码，禁止合并。
- 涉及共享资源写入（对象存储更新、缓存失效）必须有并发风险评估与测试。

### 2.2 API 规范（继承 STD-04）
- API 路径使用资源导向命名（复数名词优先）。
- 响应结构统一：
  - 成功：`{ status: "success", data, meta? }`
  - 失败：`{ status: "error", error_code, message }`
- 禁止在路由层直接返回底层异常栈。
- 请求日志必须包含：`trace_id`, `cost_ms`, `status`, `user`。

### 2.3 I18n 规范（继承 STD-07）
- 用户可见文本禁止硬编码，必须使用 I18n Key。
- 错误消息字段 `message` 必须返回资源键（如 `ERR_FORBIDDEN`）。
- 词条 Key 必须使用大写下划线格式，推荐前缀：`LBL_`, `BTN_`, `MSG_`, `ERR_`, `TXT_`, `DOC_`。
- 词条默认至少包含 `zh`, `ja`, `en` 三语。

### 2.4 数据模型规范（继承 STD-05）
- 词条资源模型必须包含审计字段：
  - `id`, `created_at`, `updated_at`, `created_by`, `updated_by`, `is_deleted`
- 存储层采用“逻辑优先，物理适配”：
  - 当前实现：MinIO/S3 对象存储（JSON 文档）
  - 后续可扩展其他物理适配器，不改变应用层接口

### 2.5 文档与协作（继承 STD-02, STD-08）
- 后端规范/流程文档放置于统一项目文档目录 `docs/process/`。
- 文件命名必须符合 `TYPE-Number-中文名称.md`。
- 交付前必须清理临时脚本和调试文件，禁止提交垃圾产物。

## 3. 禁止规则（MUST NOT）

- 禁止在路由文件直接调用 `sendJson`（必须使用 `ok/fail` 封装）。
- 禁止在接口层硬编码中文/日文/英文用户文案。
- 禁止把业务规则散落在基础设施层或 Controller/Route 层。
- 禁止绕过权限检查直接写对象存储词条。
- 禁止提交未通过 `npm run verify` 的变更。

## 4. 执行门禁

### 4.1 自动检查
- 命令：`npm run check:compliance`
- 检查内容：
  - 路由层禁止直接 `sendJson`
  - 源码中禁止 CJK 硬编码（白名单文件除外）
  - `fail(...)` 的 message 参数必须为 I18n Key

### 4.2 交付检查
- 命令：`npm run verify`
- 通过条件：合规检查 + 全量测试全部通过。

## 5. 违规处理

- 发现违规项时，必须在当前任务内立即修复，不允许“下个迭代再说”。
- 若为高风险违规（鉴权缺失、响应泄露异常栈、数据模型缺审计字段），立即阻断合并。

## 6. 当前后端落地状态（2026-02-09）

- 已落地统一响应结构与错误码键返回。
- 已落地全局请求日志字段：`trace_id/cost_ms/status/user`。
- 已落地词条审计字段与 MinIO/S3 对象存储适配。
- 已落地自动合规检查脚本：`backend/scripts/check-compliance.mjs`。
