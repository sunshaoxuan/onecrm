# PROD-03 前端驱动接口需求模板（OneCRM）

## 1. 文档目的
- 本模板用于前端向后端提交可开发、可验收的接口需求。
- 项目采用“前端驱动”模式：页面与交互是需求源头，后端据此实现能力。
- 即使由前端驱动，后端仍必须遵循分层架构（洋葱结构）、公共能力复用、权限与安全约束。

## 2. 使用规则
- 无 Figma、无正式原型图时，允许以 `HTML 原型 + 页面说明 + 示例 JSON` 作为输入。
- 前端每提交一个功能模块，必须至少提供：
  - 页面入口与交互路径
  - 字段清单（显示字段、编辑字段、隐藏字段）
  - 接口契约草案（请求/响应）
  - 权限预期（谁可见、谁可改）
- 后端对不完整需求可退回，但需明确“缺失项清单”。

## 3. 需求单基础信息
- 需求标题：
- 需求编号：
- 提交人（前端）：
- 对应页面（路由/菜单）：
- 需求优先级：`P0 | P1 | P2`
- 期望联调日期：
- 关联文档：
  - HTML 原型路径（可多个）：
  - 说明文档路径（可选）：

## 4. 页面驱动说明（替代 Figma）
### 4.1 页面来源（必填）
- 来源类型：`现网页面 | HTML 原型 | 口头确认后补文档`
- 证据路径：如 `docs/design/xxx.html`
- 页面版本：`vX.Y`

### 4.2 用户交互流（必填）
1. 用户从哪里进入：
2. 点击/输入了什么：
3. 页面发起了哪些请求：
4. 成功后页面如何变化：
5. 失败后页面如何处理：

### 4.3 前端状态定义（必填）
- 首次加载态：
- 空数据态：
- 错误态：
- 重试机制：
- 并发操作限制（防重复提交）：

## 5. 接口清单（逐个填写）
> 每个页面动作对应一个或多个接口，逐条填写。

### 5.1 接口基本信息
- 接口名称：
- 方法与路径：`GET/POST/PUT/PATCH/DELETE /api/...`
- 调用时机（由哪个页面动作触发）：
- 幂等要求：`是 | 否`（说明机制）
- 超时要求：如 `3s`

### 5.2 请求定义
- Header：
| 字段 | 必填 | 示例 | 说明 |
|---|---|---|---|

- Path 参数：
| 字段 | 类型 | 必填 | 示例 | 说明 |
|---|---|---|---|---|

- Query 参数：
| 字段 | 类型 | 必填 | 默认值 | 示例 | 说明 |
|---|---|---|---|---|---|

- Body（JSON）：
```json
{}
```

### 5.3 响应定义
- 成功响应（JSON）：
```json
{}
```

- 字段约束：
| 字段路径 | 类型 | 必返 | 可空 | 示例 | 说明 |
|---|---|---|---|---|---|

- 错误响应：
| HTTP 状态码 | 业务码 | 前端提示文案 | 是否可重试 |
|---|---|---|---|

### 5.4 列表能力（如适用）
- 分页：`page/pageSize` 或 `cursor`
- 排序：
- 过滤：
- 搜索字段：

## 6. 领域规则与状态流转（后端必须可落地）
### 6.1 业务规则
- 关键校验规则：
- 唯一性约束：
- 跨字段约束：

### 6.2 状态机
- 实体名称：
- 初始状态：
- 流转关系：如 `Draft -> Published -> Archived`
- 每次流转触发条件：
- 禁止流转说明：

### 6.3 异步任务（如 AI 摘要/翻译）
- 任务触发点：
- 结果回传方式：`轮询 | 回调 | 消息`
- 前端等待策略：
- 失败补偿策略：

## 7. 权限与安全（必填）
### 7.1 角色权限矩阵
| 角色 | 查看 | 新增 | 编辑 | 删除 | 发布 |
|---|---|---|---|---|---|

### 7.2 数据权限
- 是否按客户隔离：
- 是否按组织隔离：
- 是否需要字段级脱敏：

### 7.3 安全要求
- 鉴权方式：`JWT`（或其他）
- 是否要求操作审计日志：
- 是否涉及敏感信息（凭据、邮箱、手机号等）：
- 敏感字段处理策略：

## 8. 后端实现约束（洋葱结构）
> 该部分由前后端共同确认，防止“接口能用但架构不可维护”。

### 8.1 分层落点（必填）
- `Domain`：核心实体、值对象、领域规则（不依赖框架）
- `Application`：用例编排、事务边界、权限编排
- `Infrastructure`：数据库、外部服务（Dify/文件存储）、缓存、消息
- `Interface/API`：Controller/DTO/参数校验/错误映射

### 8.2 公共资源复用（必填）
- 本需求复用的公共组件：
  - 认证中间件：
  - 统一错误码：
  - 分页模型：
  - 审计日志：
  - 文件存储适配器：
  - AI 调用网关：
- 如新增公共能力，请写明复用范围与命名规范。

### 8.3 禁止事项
- 禁止把业务规则写入 Controller。
- 禁止页面专属字段直接污染领域实体（先经 DTO 转换）。
- 禁止绕过统一权限中间件做“页面临时特判”。

## 9. 验收标准
### 9.1 功能验收
1. Given ...
2. When ...
3. Then ...

### 9.2 接口验收
- 响应字段完整性：
- 错误码一致性：
- 性能门槛（P95）：

### 9.3 回归范围
- 受影响页面：
- 受影响接口：
- 受影响公共模块：

## 10. 提交流程（建议）
1. 前端按本模板提交需求单。
2. 后端 24h 内返回：通过 / 驳回（缺失项列表）。
3. 双方冻结 v1 契约（字段、错误码、权限）。
4. 后端开发与单测，前端准备联调脚本。
5. 联调后若改契约，必须升级版本并记录变更。

## 11. 版本记录
| 版本 | 日期 | 修改人 | 说明 |
|---|---|---|---|
| v1.0 | 2026-02-09 | Codex | 初版，适配 OneCRM 前端驱动模式 |

